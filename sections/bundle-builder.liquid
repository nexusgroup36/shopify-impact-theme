{% comment %}
  sections/bundle-builder.liquid
  Impact-compatible bundle builder + warranty toggle (original implementation).
  How to use:
  1) Add this section to your product template that sells single units in multiple colors (variants).
  2) Configure bundle “packs” in the section settings (size, per-item price, compare price, labels, images).
  3) Choose the product that supplies colors (variants). Variant images/titles auto-populate.
  4) (Optional) Configure warranty card text/price. If you use a selling plan or separate SKU for warranty,
     add it with "warranty_product" (product picker) and optionally a selling plan ID.
{% endcomment %}

<section class="bbn section-{{ section.id }}" data-section-id="{{ section.id }}">
  {% assign p = all_products[section.settings.product_handle] %}
  {% if p == nil %}
    <div class="page-width">
      <p style="color:#b00">Select a product in the section settings.</p>
    </div>
  {% else %}
  <div class="page-width">
    <div class="bbn-step bbn-step-1" data-step="1">
      <div class="bbn-step-title">Step 1: Choose Your Bundle</div>

      <div class="bbn-bundles" id="bbn-bundles-{{ section.id }}">
        {% for block in section.blocks %}
          {% if block.type == 'pack' %}
            {% assign pack_size = block.settings.size | default: 1 %}
            {% assign price_each = block.settings.price_each | times: 100 | round %}
            {% assign cmp_each   = block.settings.compare_each | times: 100 | round %}
            <div class="bbn-bundle{% if forloop.index == 2 %} is-active{% endif %}"
                 data-size="{{ pack_size }}"
                 data-price-each="{{ price_each }}"
                 data-compare-each="{{ cmp_each }}"
                 {{ block.shopify_attributes }}>
              {% if block.settings.label_top != blank %}
                <div class="bbn-bundle__label-top">{{ block.settings.label_top }}</div>
              {% endif %}
              <div class="bbn-bundle__body">
                <div class="bbn-bundle__image">
                  {% if block.settings.image %}
                    {{ block.settings.image | image_url: width: 400 | image_tag: loading: 'lazy', width: 200, height: 200, alt: pack_size | append: ' Pack' }}
                  {% else %}
                    {{ p.featured_image | image_url: width: 400 | image_tag: loading: 'lazy', width: 200, height: 200, alt: pack_size | append: ' Pack' }}
                  {% endif %}
                </div>
                <div class="bbn-bundle__title">{{ pack_size }} {{ section.settings.bundle_title | default: p.title }}</div>
                <div class="bbn-bundle__prices">
                  {% if cmp_each > 0 %}
                    <span class="bbn-bundle__compare">{{ cmp_each | money }}</span>
                  {% endif %}
                  <span class="bbn-bundle__real">{{ price_each | money }} each</span>
                </div>
                {% if block.settings.label_bottom != blank %}
                  <div class="bbn-bundle__label-bottom">{{ block.settings.label_bottom }}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <button class="bbn-btn bbn-btn--primary bbn-btn--full bbn-next">Next: Choose Your Colors</button>
    </div>

    <div class="bbn-step bbn-step-2 is-hidden" data-step="2">
      <div class="bbn-step-title">Step 2: Choose Your Colors</div>

      <div class="bbn-colors">
  {% for v in p.variants %}
    {% assign media = v.featured_media | default: v.image | default: p.featured_image %}
    <div class="bbn-color"
         data-id="{{ v.id }}"
         data-title="{{ v.title | escape }}"
         data-img="{{ media | image_url: width: 200 }}">
      <img src="{{ media | image_url: width: 200 }}"
           width="100" height="100"
           alt="{{ v.title | escape }}">
      <button class="bbn-color__btn" type="button">Add</button>
    </div>
  {% endfor %}
</div>

      <div class="bbn-selected">
        <div class="bbn-selected__header">
          <div class="bbn-selected__title">
            Your <span class="bbn-pack-size">0</span>-pack includes:
          </div>
          <div class="bbn-selected__prices">
            <div class="bbn-compare bbn-money"></div>
            <div class="bbn-real bbn-money"></div>
          </div>
        </div>

        <div class="bbn-selected__list" aria-live="polite"></div>
      </div>

      <div class="bbn-actions">
        <button class="bbn-btn bbn-btn--ghost bbn-back">Back</button>
        <button class="bbn-btn bbn-btn--primary bbn-add" disabled>Add Bundle To Cart</button>
      </div>
    </div>

    {% if section.settings.show_warranty %}
    <div class="bbn-warranty" data-warranty-enabled="false">
      <div class="bbn-warranty__header">
        <div class="bbn-warranty__text">{{ section.settings.warranty_heading }}</div>
        <div class="bbn-warranty__toggle">
          <div class="bbn-toggle" role="switch" aria-checked="false" tabindex="0"></div>
          <div class="bbn-warranty__title">{{ section.settings.warranty_title }}</div>
          <div class="bbn-warranty__price">{{ section.settings.warranty_price | times: 100 | round | money }}</div>
        </div>
      </div>
      <div class="bbn-warranty__features">
  {% for f in (1..3) %}
    {% assign feat_key = 'w_feat_'  | append: f %}
    {% assign icon_key = 'w_icon_'  | append: f %}
    {% assign txt      = section.settings[feat_key] %}
    {% assign ico      = section.settings[icon_key] %}

    {% if txt != blank %}
      <div class="bbn-warranty__feature">
        {% if ico %}
          {{ ico | image_url: width: 24 | image_tag: width: 24, height: 24, loading: 'lazy' }}
        {% endif %}
        <span>{{ txt }}</span>
      </div>
    {% endif %}
  {% endfor %}
</div>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <style>
    .section-{{ section.id }} { --bbn-blue:#2351ff; --bbn-blue-200:#dfe7ff; --bbn-blue-50:#f1f4ff; --bbn-gray:#e6e6e6; --bbn-radius:12px; --bbn-shadow:0 2px 0 rgba(0,0,0,.08);}
    .section-{{ section.id }} .page-width{max-width:1100px;margin:0 auto;padding:16px;}
    .bbn-step-title{font-weight:700;font-size:clamp(20px,2.2vw,28px);color:#222;margin:12px 0 16px;}
    .bbn-bundles{display:grid;gap:14px;grid-template-columns:repeat(1,minmax(0,1fr));}
    @media(min-width:750px){.bbn-bundles{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .bbn-bundle{border:1px solid #d6d6d6;border-radius:14px;overflow:hidden;box-shadow:var(--bbn-shadow);background:#fff;cursor:pointer;display:flex;flex-direction:column;}
    .bbn-bundle__label-top{background:var(--bbn-blue);color:#fff;text-align:center;padding:10px 8px;font-weight:700}
    .bbn-bundle__label-bottom{background:var(--bbn-blue);color:#fff;text-align:center;padding:8px 8px;font-weight:700;border-radius:10px;margin:10px; }
    .bbn-bundle.is-active{outline:3px solid var(--bbn-blue);}
    .bbn-bundle__body{padding:12px;}
    .bbn-bundle__image img{display:block;margin:0 auto;width:200px;height:200px;object-fit:contain}
    .bbn-bundle__title{font-weight:700;text-align:center;margin:8px 0}
    .bbn-bundle__prices{display:flex;gap:10px;justify-content:center;align-items:baseline;margin-bottom:4px}
    .bbn-bundle__compare{text-decoration:line-through;color:#6b7280}
    .bbn-bundle__real{font-weight:800}
    .bbn-btn{display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--bbn-blue);padding:12px 16px;border-radius:12px;font-weight:800}
    .bbn-btn--primary{background:var(--bbn-blue);color:#fff}
    .bbn-btn--ghost{background:#fff;color:var(--bbn-blue)}
    .bbn-btn[disabled]{opacity:.45;cursor:not-allowed}
    .bbn-btn--full{width:100%;margin-top:14px}
    .is-hidden{display:none}
    /* Step 2 */
    .bbn-colors{display:flex;gap:10px;flex-wrap:wrap}
    .bbn-color{border:1px solid #d6d6d6;border-radius:12px;padding:8px;width:106px;text-align:center}
    .bbn-color img{display:block;margin:0 auto 6px;border-radius:8px}
    .bbn-color__btn{background:var(--bbn-blue);color:#fff;border:none;border-radius:10px;padding:8px 0;width:100%;font-weight:700;cursor:pointer}
    .bbn-selected{border:2px solid #1e293b24;border-radius:14px;padding:14px;margin-top:12px}
    .bbn-selected__header{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center}
    .bbn-selected__title{font-weight:700}
    .bbn-selected__prices{display:flex;gap:12px;align-items:baseline}
    .bbn-compare{text-decoration:line-through;color:#6b7280}
    .bbn-selected__list{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .bbn-chip{border:1px dashed #9ca3af;border-radius:12px;padding:8px 10px;display:flex;align-items:center;gap:8px}
    .bbn-chip__img img{width:50px;height:50px;border-radius:10px}
    .bbn-chip__remove{background:var(--bbn-blue);color:#fff;border:none;border-radius:999px;width:22px;height:22px;line-height:22px;text-align:center;font-size:12px;cursor:pointer}
    .bbn-actions{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:600px){.bbn-actions{grid-template-columns:auto 1fr}}
    /* Warranty */
    .bbn-warranty{border:2px solid #1e293b24;border-radius:14px;padding:16px;margin-top:18px;background:var(--bbn-blue-50)}
    .bbn-warranty__header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .bbn-warranty__text{font-weight:700}
    .bbn-warranty__toggle{display:flex;align-items:center;gap:8px}
    .bbn-toggle{width:50px;height:28px;border-radius:999px;background:#cbd5e1;position:relative;box-shadow:inset 0 0 0 2px #94a3b8;transition:.2s}
    .bbn-toggle::after{content:'';position:absolute;top:3px;left:3px;width:22px;height:22px;border-radius:50%;background:#fff;transition:.2s}
    .bbn-toggle.is-on{background:var(--bbn-blue)}
    .bbn-toggle.is-on::after{left:25px}
    .bbn-warranty__features{display:flex;gap:18px;flex-wrap:wrap;margin-top:10px}
    .bbn-warranty__feature{display:flex;align-items:center;gap:8px}
  </style>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const root = document.querySelector('.section-{{ section.id }}');
    if (!root) return;

    // --- State
    const state = {
      packSize: 0,
      priceEach: 0,     // in cents
      compareEach: 0,   // in cents
      selected: [],     // {id, title, img}
      warrantyOn: false
    };

    // --- Elements
    const step1 = root.querySelector('.bbn-step-1');
    const step2 = root.querySelector('.bbn-step-2');
    const bundles = [...root.querySelectorAll('.bbn-bundle')];
    const nextBtn = root.querySelector('.bbn-next');
    const backBtn = root.querySelector('.bbn-back');
    const addBtn = root.querySelector('.bbn-add');

    const colors = [...root.querySelectorAll('.bbn-color')];
    const selectedWrap = root.querySelector('.bbn-selected__list');
    const packSizeEl = root.querySelector('.bbn-pack-size');
    const compareEl = root.querySelector('.bbn-compare');
    const realEl = root.querySelector('.bbn-real');

    const warranty = root.querySelector('.bbn-warranty');
    const toggle = warranty ? warranty.querySelector('.bbn-toggle') : null;

    // --- Utilities
    const fmtMoney = (cents) => {
      try { return new Intl.NumberFormat('{{ shop.locale }}', { style: 'currency', currency: '{{ shop.currency }}'}).format(cents/100); }
      catch(e){ return '$' + (cents/100).toFixed(2); }
    };

    const setStep = (n) => {
      if (n === 1) { step1.classList.remove('is-hidden'); step2.classList.add('is-hidden'); }
      if (n === 2) { step2.classList.remove('is-hidden'); step1.classList.add('is-hidden'); }
    };

    const renderPrices = () => {
      const totalCompare = state.compareEach > 0 ? state.compareEach * state.packSize : 0;
      const totalReal = state.priceEach * state.packSize;
      compareEl.textContent = totalCompare ? fmtMoney(totalCompare) : '';
      realEl.textContent    = fmtMoney(totalReal);
    };

    const renderSlots = () => {
      selectedWrap.innerHTML = '';
      const filled = state.selected.length;
      const needed = Math.max(state.packSize - filled, 0);

      state.selected.forEach((item, idx) => {
        const chip = document.createElement('div');
        chip.className = 'bbn-chip';
        chip.innerHTML = `
          <button class="bbn-chip__remove" aria-label="Remove" data-idx="${idx}">X</button>
          <div class="bbn-chip__img"><img src="${item.img}" alt="${item.title}"></div>
          <div>${item.title}</div>
        `;
        selectedWrap.appendChild(chip);
      });

      for (let i = 0; i < needed; i++) {
        const chip = document.createElement('div');
        chip.className = 'bbn-chip';
        chip.innerHTML = `<div class="bbn-chip__img"><img src="{{ 'placeholder-image.png' | asset_url }}" alt=""></div><div>Birdie #${state.selected.length + i + 1}</div>`;
        selectedWrap.appendChild(chip);
      }

      addBtn.disabled = (state.selected.length !== state.packSize);
      packSizeEl.textContent = state.packSize;
      renderPrices();
    };

    const selectBundle = (el) => {
      bundles.forEach(b => b.classList.remove('is-active'));
      el.classList.add('is-active');
      state.packSize   = parseInt(el.dataset.size, 10);
      state.priceEach  = parseInt(el.dataset.priceEach, 10);
      state.compareEach= parseInt(el.dataset.compareEach || '0', 10);
      state.selected   = []; // reset
      renderSlots();
    };

    // Init default (second card active by design; fallback to first)
    selectBundle(bundles.find(b => b.classList.contains('is-active')) || bundles[0]);

    // Listeners
    bundles.forEach(b => b.addEventListener('click', () => selectBundle(b)));
    nextBtn.addEventListener('click', () => setStep(2));
    backBtn.addEventListener('click', () => setStep(1));

    colors.forEach(c => {
      c.querySelector('.bbn-color__btn').addEventListener('click', () => {
        if (state.selected.length >= state.packSize) return;
        state.selected.push({
          id:   c.dataset.id,
          title:c.dataset.title,
          img:  c.dataset.img
        });
        renderSlots();
      });
    });

    selectedWrap.addEventListener('click', (e) => {
      const btn = e.target.closest('.bbn-chip__remove');
      if (!btn) return;
      const idx = parseInt(btn.dataset.idx, 10);
      state.selected.splice(idx, 1);
      renderSlots();
    });

    if (toggle) {
      const setToggle = (on) => {
        state.warrantyOn = on;
        toggle.classList.toggle('is-on', on);
        toggle.setAttribute('aria-checked', on ? 'true' : 'false');
        warranty.dataset.warrantyEnabled = on ? 'true' : 'false';
      };
      toggle.addEventListener('click', () => setToggle(!state.warrantyOn));
      toggle.addEventListener('keydown', (e) => {
        if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); setToggle(!state.warrantyOn); }
      });
    }

    // Add to cart (AJAX)
    addBtn.addEventListener('click', async () => {
      if (state.selected.length !== state.packSize) return;

      const items = state.selected.map(s => ({ id: Number(s.id), quantity: 1 }));

      // Optional: add warranty SKU or selling plan
      {% if section.settings.warranty_product != blank %}
        {% assign wprod = all_products[section.settings.warranty_product] %}
        {% if wprod and wprod.variants.first %}
          items.push({
            id: {{ wprod.variants.first.id }},
            quantity: state.warrantyOn ? 1 : 0
            {% if section.settings.warranty_selling_plan_id != blank %}, selling_plan: {{ section.settings.warranty_selling_plan_id | json }} {% endif %}
          });
        {% endif %}
      {% endif %}

      try {
        const res = await fetch('{{ routes.cart_add_url }}.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ items: items.filter(i => i.quantity > 0) })
        });
        if (!res.ok) throw new Error('Cart add failed');
        // Option: open drawer if your theme supports it
        document.dispatchEvent(new CustomEvent('cart:refresh')); // Impact listens for events in many setups
        window.location.href = '{{ routes.cart_url }}';
      } catch(err) {
        alert('Sorry, something went wrong adding your bundle. Please try again.');
        console.error(err);
      }
    });

    // First render
    renderSlots();
  });
  </script>

  {% schema %}
  {
    "name": "Bundle Builder",
    "class": "bundle-builder",
    "settings": [
      { "type": "text", "id": "product_handle", "label": "Product handle (for colors)" },
      { "type": "text", "id": "bundle_title", "label": "Bundle item name (shown after size)", "default": "Birdie 3.0" },

      { "type": "header", "content": "Warranty (Care Plan)" },
      { "type": "checkbox", "id": "show_warranty", "label": "Show care plan", "default": true },
      { "type": "text", "id": "warranty_heading", "label": "Header", "default": "Complete Care for Your Birdie" },
      { "type": "text", "id": "warranty_title", "label": "Toggle label", "default": "Birdie Care Plan" },
      { "type": "number", "id": "warranty_price", "label": "Care plan price (per order)", "default": 7 },
      { "type": "product", "id": "warranty_product", "label": "Warranty product (optional)" },
      { "type": "text", "id": "warranty_selling_plan_id", "label": "Selling plan ID (optional)", "info": "If your warranty uses a subscription selling plan, paste its numeric ID." },

      { "type": "image_picker", "id": "w_icon_1", "label": "Feature 1 icon" },
      { "type": "text", "id": "w_feat_1", "label": "Feature 1 text", "default": "Hassle-Free Replacement" },
      { "type": "image_picker", "id": "w_icon_2", "label": "Feature 2 icon" },
      { "type": "text", "id": "w_feat_2", "label": "Feature 2 text", "default": "Battery Assurance" },
      { "type": "image_picker", "id": "w_icon_3", "label": "Feature 3 icon" },
      { "type": "text", "id": "w_feat_3", "label": "Feature 3 text", "default": "No Questions Asked" }
    ],
    "blocks": [
      {
        "type": "pack",
        "name": "Bundle pack",
        "settings": [
          { "type": "number", "id": "size", "label": "Pack size", "default": 3 },
          { "type": "text", "id": "label_top", "label": "Top label (HTML allowed)", "default": "10% Off + $15 Gift (Designer Keychain worth $15)" },
          { "type": "number", "id": "price_each", "label": "Price per item", "default": 34 },
          { "type": "number", "id": "compare_each", "label": "Compare at per item (optional)", "default": 38 },
          { "type": "text", "id": "label_bottom", "label": "Bottom label (e.g., Save $3.8)", "default": "Save $3.8" },
          { "type": "image_picker", "id": "image", "label": "Pack image" }
        ]
      }
    ],
    "presets": [
      {
        "name": "Bundle Builder + Care Plan",
        "blocks": [
          { "type": "pack" },
          { "type": "pack" },
          { "type": "pack" }
        ]
      }
    ]
  }
  {% endschema %}
</section>
